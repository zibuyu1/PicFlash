# 图片处理工具产品文档

## 1. 产品概述

### 1.1 产品定位
一款基于小程序的纯前端图片处理工具，提供图片压缩、格式转换、尺寸调整、基础编辑、滤镜特效等功能，无需后端服务和云存储，所有操作均在本地完成，处理后直接保存到本地相册。

### 1.2 目标用户
需要快速处理图片的普通用户，如社交媒体内容创作者、办公人士、学生等。

### 1.3 核心价值
- **便捷高效**：纯前端处理，无需上传服务器，速度快
- **功能全面**：覆盖日常图片处理的核心需求
- **无依赖**：不依赖后端服务，可离线使用
- **跨平台**：基于Taro框架，支持多端部署

## 2. 功能模块

### 2.1 核心功能
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 图片压缩 | 智能压缩图片大小，支持自定义压缩质量 | ✅ 高 |
| 格式转换 | 支持JPG、PNG格式互转 | ✅ 高 |
| 尺寸调整 | 支持自定义尺寸和常用比例（1:1、4:3、16:9） | ✅ 高 |

### 2.2 基础编辑
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 旋转 | 支持90°、180°、270°旋转 | ⭐ 中 |
| 翻转 | 支持水平和垂直翻转 | ⭐ 中 |
| 裁剪 | 支持自由裁剪和固定比例裁剪 | ⭐ 中 |

### 2.3 滤镜特效
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 黑白滤镜 | 将彩色图片转为黑白 | ⭐ 中 |
| 复古滤镜 | 添加复古效果 | ⭐ 中 |
| 亮度调整 | 调整图片亮度 | ⭐ 中 |

### 2.4 实用工具
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 添加水印 | 支持文字水印和图片水印 | ⭐ 中 |
| 批量处理 | 支持同时处理多张图片 | ⭐ 中 |

### 2.5 特色功能
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 证件照生成 | 支持更换背景色（白/蓝/红） | 🌟 低 |
| 表情包制作 | 支持添加文字，导出为图片 | 🌟 低 |
| 长图拼接 | 支持多张图片横向/纵向拼接 | 🌟 低 |

## 3. 技术架构

### 3.1 技术栈
- **框架**：Taro 3.x
- **语言**：TypeScript
- **UI组件库**：Taro UI
- **状态管理**：Redux Toolkit
- **构建工具**：Webpack

### 3.2 架构设计

#### 3.2.1 目录结构
```
├── src/
│   ├── pages/
│   │   ├── index/           # 首页
│   │   ├── editor/          # 图片编辑器
│   │   └── batch/           # 批量处理
│   ├── components/
│   │   ├── ImageCropper/    # 裁剪组件
│   │   ├── FilterPanel/     # 滤镜面板
│   │   └── WatermarkEditor/ # 水印编辑器
│   ├── utils/
│   │   ├── imageProcessor.ts  # 图片处理核心工具
│   │   ├── canvasUtil.ts      # Canvas操作工具
│   │   └── fileUtil.ts        # 文件操作工具
│   ├── store/               # Redux状态管理
│   ├── types/               # TypeScript类型定义
│   └── app.tsx              # 应用入口
├── config/                  # Taro配置
├── package.json             # 项目依赖
└── project.config.json      # 小程序配置
```

#### 3.2.2 核心流程
1. **图片选择**：用户选择本地图片 → 获取临时文件路径
2. **图片处理**：通过Canvas API进行编辑操作 → 生成处理后的临时文件
3. **结果导出**：将处理后的图片保存到本地相册

## 4. 页面设计

### 4.1 首页
- **功能**：展示核心功能入口，如压缩、编辑、批量处理等
- **布局**：网格布局，每个功能模块一个卡片
- **交互**：点击卡片进入对应功能页面

### 4.2 图片编辑器
- **功能**：单张图片的详细编辑
- **布局**：
  - 顶部：功能导航栏（压缩、尺寸、滤镜等）
  - 中间：图片预览区域
  - 底部：编辑参数调整和操作按钮
- **交互**：
  - 滑动调整参数（如亮度、压缩质量）
  - 点击应用滤镜效果
  - 拖动裁剪区域

### 4.3 批量处理
- **功能**：同时处理多张图片
- **布局**：
  - 顶部：已选择图片列表
  - 中间：处理选项设置
  - 底部：开始处理按钮
- **交互**：
  - 选择多张图片
  - 设置统一的处理参数
  - 查看处理进度和结果

## 5. 功能实现方案

### 5.1 核心工具类 `imageProcessor.ts`

```typescript
// src/utils/imageProcessor.ts
import { createCanvasContext, getImageInfo, canvasToTempFilePath, saveImageToPhotosAlbum } from '@tarojs/taro';

/**
 * 压缩图片
 * @param imagePath 图片路径
 * @param quality 压缩质量 (0-1)
 * @param maxWidth 最大宽度
 * @returns 压缩后的图片路径
 */
export async function compressImage(imagePath: string, quality: number = 0.8, maxWidth: number = 1920): Promise<string> {
  return new Promise((resolve, reject) => {
    getImageInfo({ 
      src: imagePath,
      success: (res) => {
        const canvasId = 'compressCanvas';
        const ctx = createCanvasContext(canvasId);
        
        let width = res.width;
        let height = res.height;
        
        // 计算新尺寸
        if (width > maxWidth) {
          height = height * (maxWidth / width);
          width = maxWidth;
        }
        
        // 绘制图片
        ctx.drawImage(imagePath, 0, 0, width, height);
        ctx.draw(false, () => {
          canvasToTempFilePath({
            canvasId,
            quality,
            success: (result) => resolve(result.tempFilePath),
            fail: reject
          });
        });
      },
      fail: reject
    });
  });
}

/**
 * 转换图片格式
 * @param imagePath 图片路径
 * @param format 目标格式 (jpg/png)
 * @returns 转换后的图片路径
 */
export async function convertFormat(imagePath: string, format: 'jpg' | 'png' = 'jpg'): Promise<string> {
  return new Promise((resolve, reject) => {
    getImageInfo({ 
      src: imagePath,
      success: (res) => {
        const canvasId = 'convertCanvas';
        const ctx = createCanvasContext(canvasId);
        
        ctx.drawImage(imagePath, 0, 0, res.width, res.height);
        ctx.draw(false, () => {
          canvasToTempFilePath({
            canvasId,
            fileType: format,
            success: (result) => resolve(result.tempFilePath),
            fail: reject
          });
        });
      },
      fail: reject
    });
  });
}

/**
 * 调整图片尺寸
 * @param imagePath 图片路径
 * @param width 目标宽度
 * @param height 目标高度
 * @returns 调整后的图片路径
 */
export async function resizeImage(imagePath: string, width: number, height: number): Promise<string> {
  return new Promise((resolve, reject) => {
    getImageInfo({ 
      src: imagePath,
      success: (res) => {
        const canvasId = 'resizeCanvas';
        const ctx = createCanvasContext(canvasId);
        
        ctx.drawImage(imagePath, 0, 0, width, height);
        ctx.draw(false, () => {
          canvasToTempFilePath({
            canvasId,
            success: (result) => resolve(result.tempFilePath),
            fail: reject
          });
        });
      },
      fail: reject
    });
  });
}

/**
 * 保存图片到相册
 * @param imagePath 图片路径
 */
export async function saveToAlbum(imagePath: string): Promise<void> {
  return new Promise((resolve, reject) => {
    saveImageToPhotosAlbum({
      filePath: imagePath,
      success: resolve,
      fail: reject
    });
  });
}
```

### 5.2 页面实现示例

#### 5.2.1 首页 `index.tsx`

```tsx
// src/pages/index/index.tsx
import { View, Text, Button, Image, StyleSheet } from '@tarojs/components';
import { useRouter } from '@tarojs/taro';
import React from 'react';

const Index = () => {
  const router = useRouter();

  const navigateToEditor = (type: string) => {
    router.navigateTo({ url: `/pages/editor/index?type=${type}` });
  };

  const navigateToBatch = () => {
    router.navigateTo({ url: '/pages/batch/index' });
  };

  return (
    <View className="container">
      <View className="header">
        <Text className="title">图片处理工具</Text>
      </View>
      
      <View className="grid">
        <View className="card" onClick={() => navigateToEditor('compress')}>
          <Image src="/assets/compress.png" className="icon" />
          <Text className="card-title">图片压缩</Text>
        </View>
        
        <View className="card" onClick={() => navigateToEditor('resize')}>
          <Image src="/assets/resize.png" className="icon" />
          <Text className="card-title">尺寸调整</Text>
        </View>
        
        <View className="card" onClick={() => navigateToEditor('convert')}>
          <Image src="/assets/convert.png" className="icon" />
          <Text className="card-title">格式转换</Text>
        </View>
        
        <View className="card" onClick={() => navigateToEditor('edit')}>
          <Image src="/assets/edit.png" className="icon" />
          <Text className="card-title">基础编辑</Text>
        </View>
        
        <View className="card" onClick={() => navigateToEditor('filter')}>
          <Image src="/assets/filter.png" className="icon" />
          <Text className="card-title">滤镜特效</Text>
        </View>
        
        <View className="card" onClick={navigateToBatch}>
          <Image src="/assets/batch.png" className="icon" />
          <Text className="card-title">批量处理</Text>
        </View>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  header: {
    padding: 20,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e8e8e8',
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  grid: {
    padding: 10,
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
  },
  card: {
    width: '30%',
    backgroundColor: '#fff',
    padding: 20,
    marginBottom: 15,
    borderRadius: 8,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 3.84,
    elevation: 5,
  },
  icon: {
    width: 60,
    height: 60,
    marginBottom: 10,
  },
  cardTitle: {
    fontSize: 14,
    textAlign: 'center',
  },
});

export default Index;
```

#### 5.2.2 编辑器页面 `editor.tsx`

```tsx
// src/pages/editor/index.tsx
import { View, Text, Image, Slider, Button, StyleSheet } from '@tarojs/components';
import { useRouter, chooseImage } from '@tarojs/taro';
import React, { useState, useEffect } from 'react';
import { compressImage, resizeImage, convertFormat, saveToAlbum } from '../../utils/imageProcessor';

const Editor = () => {
  const router = useRouter();
  const [imagePath, setImagePath] = useState<string>('');
  const [processedPath, setProcessedPath] = useState<string>('');
  const [quality, setQuality] = useState<number>(0.8);
  const [width, setWidth] = useState<number>(1080);
  const [height, setHeight] = useState<number>(1080);
  const [format, setFormat] = useState<'jpg' | 'png'>('jpg');
  const [loading, setLoading] = useState<boolean>(false);

  const type = router.params.type as string;

  useEffect(() => {
    chooseImageAsync();
  }, []);

  const chooseImageAsync = async () => {
    try {
      const res = await chooseImage({
        count: 1,
        sizeType: ['original', 'compressed'],
        sourceType: ['album', 'camera'],
      });
      setImagePath(res.tempFilePaths[0]);
      setProcessedPath(res.tempFilePaths[0]);
    } catch (error) {
      console.error('选择图片失败:', error);
    }
  };

  const handleProcess = async () => {
    if (!imagePath) return;

    setLoading(true);
    try {
      let resultPath: string;
      
      switch (type) {
        case 'compress':
          resultPath = await compressImage(imagePath, quality);
          break;
        case 'resize':
          resultPath = await resizeImage(imagePath, width, height);
          break;
        case 'convert':
          resultPath = await convertFormat(imagePath, format);
          break;
        default:
          resultPath = imagePath;
      }
      
      setProcessedPath(resultPath);
    } catch (error) {
      console.error('处理图片失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    if (!processedPath) return;

    try {
      await saveToAlbum(processedPath);
      Taro.showToast({ title: '保存成功', icon: 'success' });
    } catch (error) {
      console.error('保存失败:', error);
    }
  };

  return (
    <View className="container">
      <View className="header">
        <Text className="title">
          {type === 'compress' ? '图片压缩' : 
           type === 'resize' ? '尺寸调整' : 
           type === 'convert' ? '格式转换' : '图片编辑'}
        </Text>
      </View>

      <View className="preview">
        {processedPath && (
          <Image src={processedPath} className="image" mode="aspectFit" />
        )}
      </View>

      <View className="controls">
        {type === 'compress' && (
          <View className="control-item">
            <Text>压缩质量: {Math.round(quality * 100)}%</Text>
            <Slider 
              value={quality} 
              min={0.1} 
              max={1} 
              step={0.1} 
              onChange={(e) => setQuality(e.detail.value)} 
            />
          </View>
        )}

        {type === 'resize' && (
          <>
            <View className="control-item">
              <Text>宽度: {width}px</Text>
              <Slider 
                value={width} 
                min={100} 
                max={2048} 
                step={1} 
                onChange={(e) => setWidth(e.detail.value)} 
              />
            </View>
            <View className="control-item">
              <Text>高度: {height}px</Text>
              <Slider 
                value={height} 
                min={100} 
                max={2048} 
                step={1} 
                onChange={(e) => setHeight(e.detail.value)} 
              />
            </View>
          </>
        )}

        {type === 'convert' && (
          <View className="control-item">
            <Text>目标格式:</Text>
            <View className="format-buttons">
              <Button 
                className={format === 'jpg' ? 'active' : ''}
                onClick={() => setFormat('jpg')}
              >
                JPG
              </Button>
              <Button 
                className={format === 'png' ? 'active' : ''}
                onClick={() => setFormat('png')}
              >
                PNG
              </Button>
            </View>
          </View>
        )}

        <Button 
          className="process-btn" 
          onClick={handleProcess}
          loading={loading}
        >
          处理图片
        </Button>

        <Button 
          className="save-btn" 
          onClick={handleSave}
          disabled={!processedPath}
        >
          保存到相册
        </Button>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  header: {
    padding: 20,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e8e8e8',
  },
  title: {
    fontSize: 18,
    textAlign: 'center',
    fontWeight: 'bold',
  },
  preview: {
    flex: 1,
    padding: 20,
    backgroundColor: '#000',
    justifyContent: 'center',
    alignItems: 'center',
  },
  image: {
    width: '100%',
    height: '80%',
  },
  controls: {
    padding: 20,
    backgroundColor: '#fff',
  },
  controlItem: {
    marginBottom: 20,
  },
  formatButtons: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginTop: 10,
  },
  processBtn: {
    width: '100%',
    backgroundColor: '#1890ff',
    color: '#fff',
    padding: 12,
    borderRadius: 4,
    marginBottom: 10,
  },
  saveBtn: {
    width: '100%',
    backgroundColor: '#52c41a',
    color: '#fff',
    padding: 12,
    borderRadius: 4,
  },
  active: {
    backgroundColor: '#1890ff',
    color: '#fff',
  },
});

export default Editor;
```

## 6. 开发计划

### 6.1 阶段一：基础架构搭建
- 初始化Taro项目
- 配置TypeScript和UI组件库
- 创建目录结构
- 实现核心工具类

### 6.2 阶段二：核心功能开发
- 实现图片压缩功能
- 实现尺寸调整功能
- 实现格式转换功能
- 开发首页和编辑器页面

### 6.3 阶段三：扩展功能开发
- 实现基础编辑功能（旋转、翻转、裁剪）
- 实现滤镜特效功能
- 开发批量处理功能

### 6.4 阶段四：特色功能和优化
- 实现证件照生成功能
- 实现表情包制作功能
- 优化性能和用户体验
- 测试和bug修复

## 7. 注意事项

### 7.1 性能优化
- **Canvas尺寸限制**：小程序Canvas最大尺寸约为4096x4096，处理大图片时需先缩小
- **内存管理**：批量处理时控制并发数，避免内存溢出
- **加载优化**：处理过程中显示加载动画，提升用户体验

### 7.2 权限处理
- **相册权限**：保存图片到相册需要用户授权，首次保存时需处理权限请求
- **相机权限**：使用相机拍摄时需要相机权限

### 7.3 兼容性
- **Taro版本**：使用Taro 3.x版本，确保跨端兼容性
- **小程序限制**：遵守各平台小程序的限制，如文件大小、API调用频率等

### 7.4 用户体验
- **错误处理**：完善错误提示，如图片选择失败、处理失败等
- **操作反馈**：所有操作都应有明确的反馈，如加载动画、成功提示等
- **易用性**：界面设计简洁直观，操作流程清晰

### 7.5 未来扩展
- **支持更多格式**：如WebP、GIF等
- **高级编辑功能**：如抠图、AI修复等
- **云端同步**：可选的云端存储功能，用于保存编辑历史

## 8. 技术要点

1. **Canvas API**：核心图片处理依赖Canvas API，需要熟练掌握drawImage、filter等方法
2. **Taro跨端**：使用Taro框架确保多端兼容性，注意各平台API差异
3. **异步处理**：大量使用async/await处理异步操作，确保代码可读性
4. **状态管理**：使用Redux Toolkit管理复杂状态，如批量处理进度
5. **性能监控**：监控大图片处理时的性能，避免卡顿

## 9. 总结

本产品文档详细规划了基于Taro框架的图片处理工具的开发方案，涵盖了产品定位、功能模块、技术架构、页面设计、功能实现等方面。通过纯前端实现方案，无需后端服务和云存储，可快速为用户提供便捷的图片处理服务。

该方案具有以下优势：
- **技术成熟**：基于Taro和Canvas API，技术方案稳定可靠
- **功能全面**：覆盖日常图片处理的核心需求
- **用户友好**：操作简单直观，处理速度快
- **可扩展性**：架构设计合理，便于后续功能扩展

按照本文档的规划，可在2-3周内完成核心功能的开发，4-5周内完成所有功能的实现和优化。